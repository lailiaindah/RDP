name: secure-rdp-ubuntu

on:
  workflow_dispatch:

jobs:
  ubuntu-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Update system
        run: |
          sudo apt update

      - name: Install XFCE, XRDP, Xorg
        run: |
          sudo apt install -y \
            xfce4 xfce4-goodies \
            xrdp xorgxrdp dbus-x11

      - name: Configure XRDP session
        run: |
          echo "startxfce4" | sudo tee /etc/skel/.xsession
          sudo sed -i.bak '/^test -x \/etc\/X11\/Xsession && exec \/etc\/X11\/Xsession$/c\startxfce4' /etc/xrdp/startwm.sh

      - name: Enable and restart XRDP
        run: |
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp
          sudo systemctl restart xrdp-sesman

      - name: Create RDP user
        id: user
        run: |
          USER=rdp
          PASS=$(openssl rand -base64 16)

          sudo adduser --disabled-password --gecos "" $USER
          echo "$USER:$PASS" | sudo chpasswd
          sudo usermod -aG sudo $USER

          echo "RDP_USER=$USER" >> $GITHUB_ENV
          echo "RDP_PASS=$PASS" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale
        run: |
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-ubuntu-${{ github.run_id }}

      - name: Get Tailscale IP
        run: |
          IP=$(tailscale ip -4 | head -n1)
          echo "TAILSCALE_IP=$IP" >> $GITHUB_ENV

      - name: RDP Access Info
        run: |
          echo "===================================="
          echo " RDP ACCESS READY "
          echo "------------------------------------"
          echo " OS       : Ubuntu (XFCE)"
          echo " Address  : $TAILSCALE_IP"
          echo " Username : $RDP_USER"
          echo " Password : $RDP_PASS"
          echo "===================================="

      - name: Keep Runner Alive
        run: |
          while true; do sleep 300; done
