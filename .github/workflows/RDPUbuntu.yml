name: RDP Ubuntu Fixed DBUS

on:
  workflow_dispatch:

jobs:
  secure-rdp-ubuntu:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Update & Install Desktop Environment (XFCE) & XRDP
        run: |
          sudo apt-get update
          
          # PERBAIKAN 1: Tambahkan dbus-x11 dan x11-xserver-utils
          sudo apt-get install -y xfce4 xfce4-goodies xrdp dbus-x11 x11-xserver-utils
          
          # PERBAIKAN 2: Reset konfigurasi startwm.sh agar kompatibel dengan D-Bus
          # Kita backup dulu file aslinya
          sudo cp /etc/xrdp/startwm.sh /etc/xrdp/startwm.sh.bak
          
          # Kita tulis ulang startwm.sh dengan konfigurasi yang lebih stabil
          sudo bash -c "cat > /etc/xrdp/startwm.sh" <<EOF
          #!/bin/sh
          unset DBUS_SESSION_BUS_ADDRESS
          unset XDG_RUNTIME_DIR
          . /etc/X11/Xsession
          EOF
          
          sudo chmod +x /etc/xrdp/startwm.sh
          
          # Start layanan XRDP
          sudo systemctl enable xrdp
          sudo systemctl start xrdp

      - name: Create RDP User with Secure Password
        run: |
          PASSWORD=$(openssl rand -base64 16)
          USER="rdpuser"
          
          sudo useradd -m -s /bin/bash $USER
          echo "$USER:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo $USER
          
          # PERBAIKAN 3: Gunakan startxfce4 di .xsession
          echo "startxfce4" | sudo tee /home/$USER/.xsession
          sudo chown $USER:$USER /home/$USER/.xsession

          # Simpan variabel untuk step selanjutnya
          echo "RDP_USER=$USER" >> $GITHUB_ENV
          echo "RDP_PASS=$PASSWORD" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Establish Tailscale Connection
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-ubuntu-$GITHUB_RUN_ID
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Maintain Connection
        run: |
          echo "=========================================="
          echo "           RDP ACCESS DETAILS             "
          echo "=========================================="
          echo "OS       : Ubuntu (XFCE Desktop)"
          echo "Address  : $TAILSCALE_IP"
          echo "Username : $RDP_USER"
          echo "Password : $RDP_PASS"
          echo "=========================================="
          echo "RDP Active. Tekan Cancel Workflow untuk berhenti."
          sleep infinity
