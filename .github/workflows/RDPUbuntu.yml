name: ubuntu-desktop-novnc

on:
  workflow_dispatch:

jobs:
  desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install desktop & VNC stack
        run: |
          sudo apt update
          sudo apt install -y \
            xfce4 xfce4-goodies \
            xvfb x11vnc \
            novnc websockify \
            dbus-x11

      - name: Start virtual display
        run: |
          export DISPLAY=:1
          Xvfb :1 -screen 0 1280x800x16 &
          sleep 3

      - name: Start XFCE
        run: |
          export DISPLAY=:1
          startxfce4 &

      - name: Start VNC server
        run: |
          export DISPLAY=:1
          x11vnc -display :1 -nopw -forever -shared &

      - name: Start noVNC
        run: |
          websockify --web=/usr/share/novnc 6080 localhost:5900 &

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale
        run: |
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-desktop-${{ github.run_id }}

      - name: Show Access Info
        run: |
          IP=$(tailscale ip -4 | head -n1)
          echo "================================"
          echo " Ubuntu Desktop READY"
          echo "--------------------------------"
          echo " URL : http://$IP:6080"
          echo "================================"

      - name: Keep Alive
        run: |
          while true; do sleep 300; done
