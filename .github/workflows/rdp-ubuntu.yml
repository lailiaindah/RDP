name: RDP Ubuntu

on:
  workflow_dispatch:

jobs:
  secure-rdp-ubuntu:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Update & Install Desktop Environment (XFCE) & XRDP
        run: |
          sudo apt-get update
          # Install XFCE4 (Ringan dan stabil untuk RDP) dan XRDP
          sudo apt-get install -y xfce4 xfce4-goodies xrdp
          
          # Konfigurasi XRDP agar menggunakan XFCE
          sudo sed -i.bak '/fi/a #xrdp multiple-users configuration \n xfce4-session \n' /etc/xrdp/startwm.sh
          
          # Start layanan XRDP
          sudo systemctl enable xrdp
          sudo systemctl start xrdp

      - name: Create RDP User with Secure Password
        run: |
          # Generate random password
          PASSWORD=$(openssl rand -base64 16)
          USER="rdpuser"
          
          # Buat user baru
          sudo useradd -m -s /bin/bash $USER
          echo "$USER:$PASSWORD" | sudo chpasswd
          
          # Berikan akses sudo ke user tersebut (opsional)
          sudo usermod -aG sudo $USER
          
          # Pastikan session XFCE digunakan oleh user ini
          echo "xfce4-session" | sudo tee /home/$USER/.xsession
          sudo chown $USER:$USER /home/$USER/.xsession

          # Simpan kredensial ke ENV Github untuk ditampilkan nanti
          echo "RDP_USER=$USER" >> $env:GITHUB_ENV
          echo "RDP_PASS=$PASSWORD" >> $env:GITHUB_ENV
          
          echo "User created successfully."

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Establish Tailscale Connection
        run: |
          # Menjalankan Tailscale
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-ubuntu-$GITHUB_RUN_ID
          
          # Mendapatkan IP Tailscale
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $env:GITHUB_ENV

      - name: Maintain Connection
        run: |
          echo "=========================================="
          echo "           RDP ACCESS DETAILS             "
          echo "=========================================="
          echo "OS       : Ubuntu (XFCE Desktop)"
          echo "Address  : $env:TAILSCALE_IP"
          echo "Username : $env:RDP_USER"
          echo "Password : $env:RDP_PASS"
          echo "=========================================="
          echo "RDP Active. Tekan Cancel Workflow untuk berhenti."
          
          # Loop agar runner tetap hidup (Max 6 jam sesuai timeout)
          sleep infinity
